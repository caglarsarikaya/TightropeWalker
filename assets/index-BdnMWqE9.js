import{V as l,C as Dt,a as Ot,G as Y,M as D,S as H,b as S,c as Gt,B as Ct,d as j,e as xt,f as Bt,g as Wt,A as Ht,D as Yt,H as jt,P as Vt,T as ht,R as lt,h as Rt,i as Kt,j as Ut,k as _t,W as Xt,l as qt}from"./three-DM4aotli.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class $t{constructor(t,e){this.scene=t,this.camera=e,this.targetPosition=new l,this.targetLookAt=new l,this.currentLookAt=new l,this.isAnimating=!1,this.animationDuration=2,this.animationProgress=0,this.currentAnimationSpeed=.1,this.startPosition=new l(0,50,120),this.startLookAt=new l(0,0,0),this.gameplayPosition=new l(0,10,20),this.gameplayLookAt=new l(0,0,-15),this.platformFocusPosition=new l(0,8,15),this.platformFocusLookAt=new l(0,0,-50),this.character=null,this.environment=null,this.isLeftMouseDown=!1,this.isRightMouseDown=!1,this.mouseX=0,this.mouseY=0,this.lastMouseX=0,this.lastMouseY=0,this.mouseSensitivity=.2,this.zoomSpeed=.5,this.enableMouseControls=!1,this.orbitRadius=15,this.orbitAngleHorizontal=0,this.orbitAngleVertical=.5,this.minVerticalAngle=.1,this.maxVerticalAngle=Math.PI/2-.1,this.dampingFactor=.92,this.velocityX=0,this.velocityY=0,this.followTarget=null,this.followOffset=new l(0,3,8),this.followLerpFactor=.1,this.currentTargetPosition=new l,this.currentLookAtPosition=new l,this.camera.position.copy(this.startPosition),this.currentLookAt.copy(this.startLookAt),this.camera.lookAt(this.currentLookAt),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.onWheel=this.onWheel.bind(this),this.setupMouseControls()}setupMouseControls(){document.addEventListener("mousedown",this.onMouseDown),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp),document.addEventListener("contextmenu",this.onContextMenu),document.addEventListener("wheel",this.onWheel)}removeMouseControls(){document.removeEventListener("mousedown",this.onMouseDown),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),document.removeEventListener("contextmenu",this.onContextMenu),document.removeEventListener("wheel",this.onWheel)}onMouseDown(t){this.enableMouseControls&&(t.button===0?this.isLeftMouseDown=!0:t.button===2&&(this.isRightMouseDown=!0),this.lastMouseX=t.clientX,this.lastMouseY=t.clientY)}onMouseMove(t){if(!this.enableMouseControls)return;const e=t.clientX-this.lastMouseX,i=t.clientY-this.lastMouseY;if(this.isLeftMouseDown&&(this.velocityX=this.velocityX*this.dampingFactor+e*.01,this.velocityY=this.velocityY*this.dampingFactor+i*.01,this.orbitAngleHorizontal-=this.velocityX*this.mouseSensitivity,this.orbitAngleVertical+=this.velocityY*this.mouseSensitivity,this.orbitAngleVertical=Math.max(this.minVerticalAngle,Math.min(this.maxVerticalAngle,this.orbitAngleVertical)),this.isAnimating||this.updateOrbitCamera()),this.isRightMouseDown){const s=new l(1,0,0).applyQuaternion(this.camera.quaternion),o=new l(0,1,0).applyQuaternion(this.camera.quaternion),a=this.orbitRadius*.01;s.multiplyScalar(-e*this.mouseSensitivity*a),o.multiplyScalar(i*this.mouseSensitivity*a),this.camera.position.add(s).add(o),this.currentLookAt.add(s).add(o),this.targetLookAt.copy(this.currentLookAt)}this.lastMouseX=t.clientX,this.lastMouseY=t.clientY}onMouseUp(t){t.button===0?(this.isLeftMouseDown=!1,setTimeout(()=>{this.velocityX=0,this.velocityY=0},300)):t.button===2&&(this.isRightMouseDown=!1)}onContextMenu(t){this.enableMouseControls&&t.preventDefault()}onWheel(t){if(!this.enableMouseControls)return;t.preventDefault();const e=t.deltaY*this.zoomSpeed*.01;this.orbitRadius+=e,this.orbitRadius=Math.max(5,Math.min(200,this.orbitRadius)),this.isAnimating||this.updateOrbitCamera()}updateOrbitCamera(){const t=Math.sin(this.orbitAngleVertical),e=Math.cos(this.orbitAngleVertical),i=Math.sin(this.orbitAngleHorizontal),s=Math.cos(this.orbitAngleHorizontal),o=this.orbitRadius*e*i,a=this.orbitRadius*t,n=this.orbitRadius*e*s;this.camera.position.set(this.currentLookAt.x+o,this.currentLookAt.y+a,this.currentLookAt.z+n),this.camera.lookAt(this.currentLookAt)}setFollowTarget(t){if(this.followTarget=t,t){const e=t.position.clone();this.currentTargetPosition.copy(this.camera.position),this.currentLookAtPosition.copy(e)}}clearFollowTarget(){this.followTarget=null}updateFollowPosition(t,e,i){this.enableMouseControls||(this.currentTargetPosition.lerp(t,this.followLerpFactor),this.currentLookAtPosition.lerp(e,this.followLerpFactor),this.camera.position.copy(this.currentTargetPosition),this.camera.lookAt(this.currentLookAtPosition),this.currentLookAt.copy(this.currentLookAtPosition))}setMouseControlsEnabled(t){if(this.enableMouseControls=t,t){const e=new l().subVectors(this.camera.position,this.currentLookAt);this.orbitRadius=e.length(),this.orbitAngleHorizontal=Math.atan2(e.x,e.z),this.orbitAngleVertical=Math.asin(Math.min(1,Math.max(-1,e.y/this.orbitRadius)))}}setReferences(t,e){this.character=t,this.environment=e}animateToStartPosition(){const t=this.startPosition.clone(),e=this.startLookAt.clone();t.x+=(Math.random()-.5)*10,this.animateToPosition(t,e,2.5),this.setMouseControlsEnabled(!1)}animateToGameplayPosition(){this.character&&this.character.model&&this.environment&&this.environment.startPlatformPosition?(this.animateToPlatformFocus(),setTimeout(()=>{const t=this.character.model.position.clone(),e=new l(t.x,t.y+3,t.z+8),i=new l(t.x,t.y+1,t.z-10);this.setFollowTarget(this.character.model),this.currentAnimationSpeed=.15,this.animateToPosition(e,i,1.8),setTimeout(()=>{this.setMouseControlsEnabled(!0)},2e3)},3e3)):(this.gameplayPosition=new l(0,5,8),this.gameplayLookAt=new l(0,1,-10),this.animateToPosition(this.gameplayPosition,this.gameplayLookAt),setTimeout(()=>{this.setMouseControlsEnabled(!0)},3e3))}animateToPlatformFocus(){if(!this.environment||!this.environment.startPlatformPosition)return;const t=this.environment.startPlatformPosition.clone(),e=new l(t.x+10,t.y+6,t.z+10),i=new l(t.x,t.y+1,t.z-3);this.currentAnimationSpeed=.06,this.animateToPosition(e,i,3)}animateToPosition(t,e,i=null){this.isAnimating=!0,this.animationProgress=0,i!==null&&(this.animationDuration=i),this.targetPosition.copy(t),this.targetLookAt.copy(e)}update(t){if(this.isAnimating){this.animationProgress+=t/this.animationDuration,this.animationProgress>=1&&(this.animationProgress=1,this.isAnimating=!1);const e=this.smoothstep(this.animationProgress);this.camera.position.lerpVectors(this.camera.position,this.targetPosition,e*this.currentAnimationSpeed),this.currentLookAt.lerpVectors(this.currentLookAt,this.targetLookAt,e*this.currentAnimationSpeed),this.camera.lookAt(this.currentLookAt)}else this.enableMouseControls||(this.followTarget&&!this.enableMouseControls?this.updateFollowingBehavior(t):this.character&&this.character.model&&!this.character.isOnPlatform&&this.character.state!=="FALLING"&&this.followTarget(this.character.model.position))}updateFollowingBehavior(t){if(!this.followTarget)return;const e=this.followTarget.position.clone();if(this.character&&this.character.isOnPlatform){const i=this.character.facingDirection,s=new l(Math.sin(i)*this.followOffset.z,this.followOffset.y,Math.cos(i)*this.followOffset.z),o=new l(e.x-s.x,e.y+s.y,e.z-s.z);this.camera.position.lerp(o,this.followLerpFactor);const a=new l(Math.sin(i)*5,1,Math.cos(i)*5),n=new l(e.x+a.x,e.y+a.y,e.z+a.z);this.currentLookAt.lerp(n,this.followLerpFactor*1.5)}else{const i=new l(e.x,e.y+this.followOffset.y,e.z+this.followOffset.z);this.camera.position.lerp(i,this.followLerpFactor),this.currentLookAt.lerp(e,this.followLerpFactor*1.5)}this.camera.lookAt(this.currentLookAt)}followTarget(t){const e=new l(0,3,8),i=t.clone().add(e);this.camera.position.lerp(i,.05);const s=t.clone().add(new l(0,1,-5));this.currentLookAt.lerp(s,.1),this.camera.lookAt(this.currentLookAt)}smoothstep(t){return t*t*(3-2*t)}}class Zt{constructor(t,e,i){this.scene=t,this.rope=e,this.environment=i,this.model=null,this.mixer=null,this.animations={},this.currentAnimation=null,this.balance=0,this.speed=0,this.maxSpeed=5,this.position=0,this.state="IDLE",this.isOnPlatform=!0,this.prevState="",this.prevBalance=0,this.head=null,this.torso=null,this.leftArm=null,this.rightArm=null,this.leftLeg=null,this.rightLeg=null,this.balancePole=null,this.height=2,this.width=.5,this.acceleration=1,this.deceleration=2,this.balanceForce=0,this.animationClock=new Dt,this.walkCycle=0,this.balanceCycle=0,this.isMovingForward=!1,this.takingStep=!1,this.stepDistance=.03,this.stepTime=.5,this.stepTimer=0,this.stepStartPosition=0,this.stepTargetPosition=0,this.canTakeNextStep=!0,this.movementBalanceEffect=.1,this.windEffect=0,this.balanceNoiseTimer=0,this.balanceNoiseInterval=.5,this.balanceNoiseMagnitude=.01,this.continuousWalkingTime=0,this.distanceWalked=0,this.maxBalanceDifficulty=4,this.balanceRecoveryRate=.7,this.balanceDifficulty=1,this.totalStepsTaken=0,this.platformMovement={forward:!1,backward:!1,left:!1,right:!1,rotateLeft:!1,rotateRight:!1},this.platformPosition=new l,this.platformSpeed=2,this.platformRotationSpeed=2,this.facingDirection=0,this.onRopeEdge=!1,this.footstepCycle=0,this.lastFootstep=0,this.footstepInterval=.4,this.bodyBobHeight=0,this.strideBobAmount=.04,this.nearRope=!1,this.nearRopeDistance=2,this.poleHoldMode="ONE_HAND",this.lastMovementDirection=new Ot,this.playerVelocity=new l,this.naturalArmSwing=!0}async load(){this.model=new Y;const t=new D({color:16109744,roughness:.7,metalness:.1}),e=new D({color:2245802,roughness:.8,metalness:0}),i=new D({color:4473924,roughness:.9,metalness:.1}),s=new D({color:9127187,roughness:.9,metalness:.1}),o=new H(.25,16,16);this.head=new S(o,t),this.head.position.y=.9,this.head.castShadow=!0;const a=new D({color:3810320,roughness:.9,metalness:0}),n=new H(.26,16,16,0,Math.PI*2,0,Math.PI/2),c=new S(n,a);c.rotation.x=Math.PI*.1,c.position.y=.02,c.position.z=-.01,this.head.add(c);const r=new Gt({color:0}),m=new H(.035,8,8),u=new S(m,r);u.position.set(.08,.05,.22),this.head.add(u);const p=new S(m,r);p.position.set(-.08,.05,.22),this.head.add(p);const g=new Ct(.5,.7,.3);this.torso=new S(g,e),this.torso.position.y=.45,this.torso.castShadow=!0;const d=new j(.07,.07,.5,8);this.leftArm=new Y;const h=new S(d,t);h.position.y=-.25,this.leftArm.add(h),this.leftArm.position.set(.3,.65,0),this.leftArm.rotation.z=-.2,this.rightArm=new Y;const f=new S(d,t);f.position.y=-.25,this.rightArm.add(f),this.rightArm.position.set(-.3,.65,0),this.rightArm.rotation.z=.2;const w=new H(.08,8,8),y=new S(w,t);y.position.y=-.5,this.leftArm.add(y);const M=new S(w,t);M.position.y=-.5,this.rightArm.add(M);const P=new j(.09,.07,.6,8);this.leftLeg=new Y;const b=new S(P,e);b.position.y=-.3,this.leftLeg.add(b),this.leftLeg.position.set(.15,.1,0),this.rightLeg=new Y;const L=new S(P,e);L.position.y=-.3,this.rightLeg.add(L),this.rightLeg.position.set(-.15,.1,0);const C=new Ct(.12,.05,.2),R=new S(C,i);R.position.set(0,-.6,.05),this.leftLeg.add(R);const v=new S(C,i);v.position.set(0,-.6,.05),this.rightLeg.add(v);const A=new j(.03,.03,3,8);return this.balancePole=new S(A,s),this.balancePole.castShadow=!0,this.updatePolePosition(),this.model.add(this.head),this.model.add(this.torso),this.model.add(this.leftArm),this.model.add(this.rightArm),this.model.add(this.leftLeg),this.model.add(this.rightLeg),this.model.add(this.balancePole),this.model.castShadow=!0,this.updatePosition(),this.scene.add(this.model),Promise.resolve()}updatePolePosition(){this.balancePole&&(this.poleHoldMode==="ONE_HAND"?(this.balancePole.rotation.set(0,0,0),this.balancePole.position.set(-.4,.4,.2),this.balancePole.rotation.z=-Math.PI*.05,this.balancePole.scale.set(.9,.9,.9)):this.poleHoldMode==="TWO_HAND"&&(this.balancePole.rotation.set(Math.PI/2,0,Math.PI/2),this.balancePole.position.set(0,.6,.1),this.balancePole.scale.set(1,1,1)))}updatePosition(){if(!this.model||!this.rope)return;if(this.isOnPlatform&&this.environment){if(this.platformPosition.length()===0&&this.environment.startPlatformPosition){const a=this.environment.startPlatformPosition,n=this.environment.platformRadius,c=this.environment.platformHeight||0;if(this.platformPosition.set(a.x,a.y+c,a.z-n*.6),console.log("Character positioned on platform at:",this.platformPosition),this.environment.endPlatformPosition){const r=new l().copy(this.environment.endPlatformPosition).sub(a).normalize();this.facingDirection=Math.atan2(r.x,r.z)}}this.model.position.copy(this.platformPosition),this.state==="WALKING"?this.bodyBobHeight=Math.abs(Math.sin(this.footstepCycle))*this.strideBobAmount:this.bodyBobHeight*=.8,this.model.position.y+=this.height/2-1+this.bodyBobHeight,this.model.rotation.y=this.facingDirection,this.checkRopeProximity();return}const t=this.rope.geometry.parameters.path,e=t.getPointAt(this.position),i=t.getTangentAt(this.position);this.model.position.copy(e),this.model.position.y+=this.height/2-1+this.rope.geometry.parameters.radius;const s=new l(1,0,0);this.model.position.add(s.multiplyScalar(this.balance*.3));const o=new l().copy(e).add(i);this.model.lookAt(o),this.model.rotation.z=this.balance*Math.PI/8,this.updateAnimations()}checkRopeProximity(){if(!this.environment||!this.rope)return;const t=this.rope.geometry.parameters.path.getPointAt(0),e=this.platformPosition.distanceTo(t),i=new l().copy(t).sub(this.platformPosition).normalize(),o=new l(Math.sin(this.facingDirection),0,Math.cos(this.facingDirection)).dot(i),a=o>.5,n=Math.acos(Math.max(-1,Math.min(1,o)))*(180/Math.PI);console.log("Distance to rope:",e.toFixed(2),"Angle to rope:",n.toFixed(1)+"°","Facing rope:",a);const c=this.nearRope,r=this.onRopeEdge;this.nearRope=e<this.nearRopeDistance+1&&a,this.onRopeEdge=e<2.5&&a,e<1&&(this.onRopeEdge=!0,console.log("FORCED ROPE EDGE - very close to rope")),this.onRopeEdge?this.poleHoldMode!=="TWO_HAND"&&(this.poleHoldMode="TWO_HAND",this.updatePolePosition(),console.log("At rope edge - holding pole with two hands")):this.nearRope?this.poleHoldMode!=="TWO_HAND"&&(this.poleHoldMode="TWO_HAND",this.updatePolePosition(),console.log("Near rope - holding pole with two hands")):this.poleHoldMode!=="ONE_HAND"&&(this.poleHoldMode="ONE_HAND",this.updatePolePosition(),console.log("Away from rope - holding pole with one hand")),(c!==this.nearRope||r!==this.onRopeEdge)&&(this.state==="WALKING"?this.playWalkingAnimation():this.playIdleAnimation()),this.platformMovement.forward&&(this.onRopeEdge||e<2)&&e<2.5&&(n<45||e<1)&&(console.log("Initiating transition to rope - W pressed at edge"),this.transitionToRope())}playIdleAnimation(){this.isOnPlatform?this.nearRope||this.onRopeEdge?(this.leftArm.rotation.set(0,0,-.3),this.rightArm.rotation.set(0,0,.3),this.leftLeg.rotation.set(.1,0,0),this.rightLeg.rotation.set(.1,0,0),this.head.rotation.set(.2,0,0)):(this.leftArm.rotation.set(0,0,-.2),this.rightArm.rotation.set(.2,0,.3),this.leftLeg.rotation.set(0,0,0),this.rightLeg.rotation.set(0,0,0),this.head.rotation.set(0,0,0)):(this.leftArm.rotation.set(0,0,-.2),this.rightArm.rotation.set(0,0,.2),this.leftLeg.rotation.set(0,0,0),this.rightLeg.rotation.set(0,0,0),this.head.rotation.set(0,0,0),this.torso.rotation.set(0,0,0)),this.updatePolePosition()}playWalkingAnimation(){this.isOnPlatform?this.nearRope||this.onRopeEdge?(this.leftArm.rotation.set(0,0,-.3),this.rightArm.rotation.set(0,0,.3),this.footstepInterval=.6):(this.leftArm.rotation.set(0,0,-.2),this.rightArm.rotation.set(.2,0,.3),this.footstepInterval=.4):(this.leftArm.rotation.set(0,0,-.2),this.rightArm.rotation.set(0,0,.2)),this.updatePolePosition()}updateAnimations(){const t=this.prevState!==this.state,e=Math.abs(this.prevBalance-this.balance)>.2;if(t||e){switch(this.state){case"IDLE":this.playIdleAnimation();break;case"WALKING":this.playWalkingAnimation();break;case"BALANCING":this.playBalancingAnimation();break;case"FALLING":this.playFallingAnimation();break}this.prevState=this.state,this.prevBalance=this.balance}const i=this.animationClock.getDelta();if(this.state==="WALKING"){this.walkCycle+=i*this.speed*3;const s=Math.sin(this.walkCycle)*.3;this.leftLeg.rotation.x=s,this.rightLeg.rotation.x=-s;const o=Math.sin(this.walkCycle)*.15;this.leftArm.rotation.x=-o,this.rightArm.rotation.x=o}if(this.state==="WALKING"||this.state==="BALANCING"){this.balanceCycle+=i*2;const s=Math.abs(this.balance)*.7;if(this.balance<-.1)this.rightArm.rotation.z=-.8*s,this.leftArm.rotation.z=-.2,this.balancePole.rotation.y=-this.balance*.2;else if(this.balance>.1)this.leftArm.rotation.z=.8*s,this.rightArm.rotation.z=.2,this.balancePole.rotation.y=-this.balance*.2;else{const a=Math.sin(this.balanceCycle)*.05;this.leftArm.rotation.z=-.2+a,this.rightArm.rotation.z=.2-a,this.balancePole.rotation.y=a*2}const o=Math.sin(this.balanceCycle*1.5)*.02;this.head.rotation.z=o,this.torso.rotation.z=o}}playBalancingAnimation(){this.leftArm.rotation.set(0,0,-.5),this.rightArm.rotation.set(0,0,.5),this.leftLeg.rotation.x=.1,this.rightLeg.rotation.x=.1}playFallingAnimation(){Math.sign(this.balance)*Math.PI/2,this.leftArm.rotation.set(.5,0,-.8),this.rightArm.rotation.set(.5,0,.8),this.leftLeg.rotation.set(.5,0,0),this.rightLeg.rotation.set(-.3,0,0),this.head.rotation.set(.3,0,0)}moveForward(){console.log("moveForward called, isOnPlatform:",this.isOnPlatform),this.isOnPlatform?(this.platformMovement.forward=!0,this.state="WALKING",console.log("Platform walking forward activated")):this.isMovingForward=!0}stopMoving(){this.isOnPlatform?(this.platformMovement.forward=!1,this.isAnyMovementKeyPressed()||(this.state="IDLE")):(this.isMovingForward=!1,this.takingStep||(this.state="BALANCING"))}moveBackward(){console.log("moveBackward called, isOnPlatform:",this.isOnPlatform),this.isOnPlatform&&(this.platformMovement.backward=!0,this.state="WALKING",console.log("Platform walking backward activated"))}stopMovingBackward(){this.isOnPlatform&&(this.platformMovement.backward=!1,this.isAnyMovementKeyPressed()||(this.state="IDLE"))}moveLeft(){console.log("moveLeft called, isOnPlatform:",this.isOnPlatform),this.isOnPlatform?(this.platformMovement.left=!0,this.state="WALKING",console.log("Platform walking left activated")):this.adjustBalance(-1)}stopMovingLeft(){this.isOnPlatform?(this.platformMovement.left=!1,this.isAnyMovementKeyPressed()||(this.state="IDLE")):this.adjustBalance(0)}moveRight(){console.log("moveRight called, isOnPlatform:",this.isOnPlatform),this.isOnPlatform?(this.platformMovement.right=!0,this.state="WALKING",console.log("Platform walking right activated")):this.adjustBalance(1)}stopMovingRight(){this.isOnPlatform?(this.platformMovement.right=!1,this.isAnyMovementKeyPressed()||(this.state="IDLE")):this.adjustBalance(0)}isAnyMovementKeyPressed(){return this.platformMovement.forward||this.platformMovement.backward||this.platformMovement.left||this.platformMovement.right}adjustBalance(t){if(!this.isOnPlatform){if(this.balanceForce=t,t<0){const e=Math.abs(t)*.7;this.rightArm.rotation.z=-.8*e,this.balancePole.rotation.y=.3*e}else if(t>0){const e=Math.abs(t)*.7;this.leftArm.rotation.z=.8*e,this.balancePole.rotation.y=-.3*e}}}setWindEffect(t){this.windEffect=t}resetPosition(){this.position=0,this.balance=0,this.speed=0,this.state="IDLE",this.balanceForce=0,this.isOnPlatform=!0,this.isMovingForward=!1,this.windEffect=0,this.platformMovement.forward=!1,this.platformMovement.backward=!1,this.platformMovement.left=!1,this.platformMovement.right=!1,this.platformPosition=new l,this.poleHoldMode="ONE_HAND",this.updatePolePosition(),this.updatePosition()}update(t){if(this.isOnPlatform){this.updatePlatformMovement(t),this.updatePosition();return}if(this.takingStep){this.stepTimer+=t;const e=Math.min(1,this.stepTimer/this.stepTime),i=this.easeInOutQuad(e);if(this.position=this.stepStartPosition+(this.stepTargetPosition-this.stepStartPosition)*i,e>=1&&(this.takingStep=!1,this.isMovingForward&&this.position<.98?this.startNewStep():this.state="BALANCING",this.totalStepsTaken>10)){const s=.03*this.balanceDifficulty;this.balance+=(Math.random()-.5)*s}}else{if(this.isMovingForward&&this.position<.98&&this.startNewStep(),Math.abs(this.balance)>.1){const e=-Math.sign(this.balance)*this.balanceRecoveryRate*t;this.balance+=e}!this.takingStep&&this.stepTimer>2&&(this.balanceDifficulty=Math.max(1,this.balanceDifficulty-t*.3)),Math.abs(this.balance)>.3?this.state="BALANCING":this.state="IDLE"}if(this.balanceNoiseTimer+=t,this.balanceNoiseTimer>=this.balanceNoiseInterval){this.balanceNoiseTimer=0;const e=(Math.random()-.5)*this.balanceNoiseMagnitude*this.balanceDifficulty,i=this.windEffect*this.balanceNoiseMagnitude*.4*this.balanceDifficulty;this.balance+=e+i}this.balance+=this.balanceForce*t*2/(Math.sqrt(this.balanceDifficulty)*.6),this.balance+=this.windEffect*t*.3*this.balanceDifficulty,this.balance=Math.max(-1,Math.min(1,this.balance)),this.updateState(),this.updatePosition(),this.takingStep||(this.stepTimer+=t),this.position>=.98&&this.transitionToEndPlatform()}easeInOutQuad(t){return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2}updateState(){if(this.isOnPlatform||this.state==="FALLING")return;if(this.takingStep){this.state="WALKING";return}const t=Math.abs(this.balance);t>.9?this.state="FALLING":t>.5?this.state="BALANCING":this.state="IDLE"}startNewStep(){this.takingStep=!0,this.stepTimer=0,this.stepStartPosition=this.position,this.stepTargetPosition=Math.min(1,this.position+this.stepDistance),this.state="WALKING";const t=this.movementBalanceEffect*this.balanceDifficulty,e=Math.random()-.5+this.windEffect*.2;if(this.balance+=t*e,this.totalStepsTaken++,this.totalStepsTaken>5){const i=1+Math.min(this.maxBalanceDifficulty-1,this.totalStepsTaken/20*(this.maxBalanceDifficulty-1));this.balanceDifficulty=Math.min(this.balanceDifficulty+.2,i)}}updatePlatformMovement(t){if(!this.isOnPlatform)return;console.log("Platform movement flags:","W:",this.platformMovement.forward,"S:",this.platformMovement.backward,"A:",this.platformMovement.left,"D:",this.platformMovement.right,"Q:",this.platformMovement.rotateLeft,"E:",this.platformMovement.rotateRight),this.platformMovement.rotateLeft&&(this.facingDirection+=this.platformRotationSpeed*t,this.model.rotation.y=this.facingDirection),this.platformMovement.rotateRight&&(this.facingDirection-=this.platformRotationSpeed*t,this.model.rotation.y=this.facingDirection);let e=0,i=0;this.platformMovement.forward&&(i+=Math.cos(this.facingDirection),e+=Math.sin(this.facingDirection)),this.platformMovement.backward&&(i-=Math.cos(this.facingDirection),e-=Math.sin(this.facingDirection)),this.platformMovement.left&&(i-=Math.sin(this.facingDirection),e+=Math.cos(this.facingDirection)),this.platformMovement.right&&(i+=Math.sin(this.facingDirection),e-=Math.cos(this.facingDirection)),(e!==0||i!==0)&&this.lastMovementDirection.set(e,i).normalize();const s=e!==0||i!==0,o=this.platformMovement.rotateLeft||this.platformMovement.rotateRight;if(s){const a=Math.sqrt(e*e+i*i);e/=a,i/=a;let n=this.platformSpeed;this.nearRope?n*=.6:this.onRopeEdge&&(n*=.4),e*=n*t,i*=n*t,this.playerVelocity.set(e/t,0,i/t),this.platformPosition.x+=e,this.platformPosition.z+=i,console.log("Platform position updated:",this.platformPosition.x.toFixed(2),this.platformPosition.z.toFixed(2)),this.constrainToPlatform(),this.state!=="WALKING"&&(this.state="WALKING",this.playWalkingAnimation()),this.footstepCycle+=t*n*5,this.lastFootstep+=t,this.lastFootstep>=this.footstepInterval&&(this.lastFootstep=0,this.createFootstepEffect()),this.updateWalkingAnimations(t)}else o?(this.state!=="WALKING"&&(this.state="WALKING",this.playWalkingAnimation()),this.footstepCycle+=t*this.platformRotationSpeed*2,this.updateWalkingAnimations(t)):(this.playerVelocity.multiplyScalar(.9),this.lastFootstep=this.footstepInterval,this.state==="WALKING"&&(this.state="IDLE",this.playIdleAnimation()))}createFootstepEffect(){const t=Math.sin(this.footstepCycle)>0;console.log(`Footstep: ${t?"Left":"Right"} foot${this.nearRope?" (careful)":""}`)}updateWalkingAnimations(t){this.playerVelocity.length();const e=Math.sin(this.footstepCycle)*.4;if(this.leftLeg.rotation.x=e,this.rightLeg.rotation.x=-e,this.nearRope||this.onRopeEdge||!this.naturalArmSwing)this.leftArm.rotation.x=0,this.rightArm.rotation.x=0;else{const s=-Math.sin(this.footstepCycle)*.3;this.leftArm.rotation.x=s,this.rightArm.rotation.x=s*.3}this.torso.rotation.y=Math.sin(this.footstepCycle)*.05,!this.nearRope&&!this.onRopeEdge&&(this.head.rotation.y=Math.sin(this.footstepCycle*.5)*.05),(this.platformMovement.left||this.platformMovement.right)&&!(this.platformMovement.forward||this.platformMovement.backward)&&this.isOnPlatform?this.platformMovement.left?this.torso.rotation.z=Math.max(-.15,this.torso.rotation.z-.02):this.platformMovement.right&&(this.torso.rotation.z=Math.min(.15,this.torso.rotation.z+.02)):this.torso.rotation.z*=.9}transitionToRope(){console.log("Transitioning to rope..."),this.poleHoldMode="TWO_HAND",this.updatePolePosition(),this.isOnPlatform=!1,this.position=0,this.balance=0,this.state="WALKING",this.platformMovement.forward=!1,this.platformMovement.backward=!1,this.platformMovement.left=!1,this.platformMovement.right=!1,this.platformMovement.rotateLeft=!1,this.platformMovement.rotateRight=!1,this.isMovingForward=!0,this.startNewStep(),this.footstepCycle=0,this.lastFootstep=0,this.bodyBobHeight=0,this.updatePosition(),console.log("Transition complete. isOnPlatform:",this.isOnPlatform,"isMovingForward:",this.isMovingForward)}transitionToEndPlatform(){if(this.isOnPlatform=!0,this.environment&&this.environment.endPlatformPosition){const t=this.environment.endPlatformPosition;this.environment.platformRadius,this.platformPosition.copy(t);const i=this.rope.geometry.parameters.path.getPointAt(1),s=new l().copy(t).sub(i).normalize();this.platformPosition.add(s.multiplyScalar(this.width)),this.facingDirection=Math.atan2(s.x,s.z)}this.position=1,this.balance=0,this.state="IDLE",this.balanceForce=0,this.isMovingForward=!1,this.takingStep=!1,this.totalStepsTaken=0,this.balanceDifficulty=1,this.playIdleAnimation()}constrainToPlatform(){if(!this.environment)return;let t,e;if(this.environment.startPlatformPosition&&this.platformPosition.distanceTo(this.environment.startPlatformPosition)<this.platformPosition.distanceTo(this.environment.endPlatformPosition||new l(0,0,0)))t=this.environment.startPlatformPosition,e=this.environment.platformRadius;else if(this.environment.endPlatformPosition)t=this.environment.endPlatformPosition,e=this.environment.platformRadius;else return;const i=this.platformPosition.x-t.x,s=this.platformPosition.z-t.z,o=Math.sqrt(i*i+s*s),a=this.rope.geometry.parameters.path.getPointAt(0),n=this.platformPosition.distanceTo(a);if(n<1.5){console.log("Close to rope - allowing unrestricted movement"),this.platformMovement.forward&&n<1&&(console.log("FORCING rope transition from constrainToPlatform"),this.transitionToRope());return}if(o>e-this.width/2){const c=i/o,r=s/o,m=new l().subVectors(a,t).normalize(),u=c*m.x+r*m.z,p=Math.max(-1,Math.min(1,u)),d=Math.acos(p)*(180/Math.PI);if(d<15)console.log("Character in rope opening, angle to rope:",d.toFixed(1)+"°"),this.platformMovement.forward&&new l(Math.sin(this.facingDirection),0,Math.cos(this.facingDirection)).dot(m)>.3&&n<3&&(console.log("Moving toward rope in platform opening - initiating transition"),this.transitionToRope());else{const f=e-this.width/2;this.platformPosition.x=t.x+c*f,this.platformPosition.z=t.z+r*f,console.log("Constrained to platform edge, angle to rope:",d.toFixed(1)+"°")}}}rotateLeft(){console.log("rotateLeft called, isOnPlatform:",this.isOnPlatform),this.isOnPlatform&&(this.platformMovement.rotateLeft=!0)}stopRotatingLeft(){this.isOnPlatform&&(this.platformMovement.rotateLeft=!1)}rotateRight(){console.log("rotateRight called, isOnPlatform:",this.isOnPlatform),this.isOnPlatform&&(this.platformMovement.rotateRight=!0)}stopRotatingRight(){this.isOnPlatform&&(this.platformMovement.rotateRight=!1)}}class Qt{constructor(){this.gravity=9.8,this.windForce=0,this.windDirection=0,this.balanceThreshold=.8,this.balanceRecoveryRate=.1,this.windChangeFrequency=3,this.maxWindForce=.5,this.windTimer=0}applyForces(t,e){this.updateWind(e),(t.state==="WALKING"||t.state==="BALANCING")&&(t.balance+=this.windForce*this.windDirection*e,t.balance+=t.speed*(t.balance>0?.1:-.1)*e,t.balance>0?t.balance-=this.balanceRecoveryRate*e:t.balance<0&&(t.balance+=this.balanceRecoveryRate*e),t.balance=Math.max(-1,Math.min(1,t.balance)))}updateWind(t){this.windTimer+=t,this.windTimer>=this.windChangeFrequency&&(this.generateRandomWind(),this.windTimer=0)}generateRandomWind(){this.windDirection=Math.random()*2-1,this.windForce=Math.random()*this.maxWindForce}checkBalance(t){return Math.abs(t.balance)>this.balanceThreshold?(t.state="FALLING",!1):!0}increaseDifficulty(t){this.maxWindForce=.5+t*.5,this.balanceRecoveryRate=.1*(1-t*.5)}}class Jt{constructor(t){this.game=t,this.startScreen=document.getElementById("start-screen"),this.gameplayUI=document.getElementById("gameplay-ui"),this.endScreen=document.getElementById("end-screen"),this.playButton=document.getElementById("play-button"),this.tryAgainButton=document.getElementById("try-again-button"),this.endMessage=document.getElementById("end-message"),this.performanceMetrics=document.getElementById("performance-metrics"),this.balanceIndicator=document.getElementById("balance-indicator"),this.balanceMarker=document.getElementById("balance-marker"),this.windDirectionElement=document.getElementById("wind-direction"),this.progressBar=document.getElementById("progress-bar"),this.createNotificationContainer(),this.notificationTimeout=null,this.setupEventListeners(),this.game.gameState.addStateChangeListener(this.onGameStateChange.bind(this))}createNotificationContainer(){let t=document.getElementById("notification-container");if(!t){t=document.createElement("div"),t.id="notification-container",t.className="notification-container";const e=document.createElement("div");e.id="notification",e.className="notification",t.appendChild(e),document.body.appendChild(t),this.addNotificationStyles()}this.notificationContainer=t,this.notification=document.getElementById("notification")}addNotificationStyles(){const t=document.createElement("style");t.textContent=`
            .notification-container {
                position: absolute;
                top: 20px;
                right: 20px;
                z-index: 1000;
                pointer-events: none;
            }
            
            .notification {
                background-color: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                font-size: 1.1rem;
                font-weight: 600;
                text-align: center;
                opacity: 0;
                transform: translateY(-20px);
                transition: opacity 0.3s ease, transform 0.3s ease;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(3px);
                max-width: 300px;
            }
            
            .notification.visible {
                opacity: 1;
                transform: translateY(0);
            }
            
            .controls-panel {
                position: absolute;
                top: 20px;
                right: 20px;
                background-color: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 15px;
                border-radius: 10px;
                font-size: 0.9rem;
                z-index: 999;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(3px);
                transition: opacity 0.3s ease;
                opacity: 0;
            }
            
            .controls-panel.visible {
                opacity: 1;
            }
            
            .controls-panel h3 {
                margin: 0 0 10px 0;
                font-size: 1rem;
                text-align: center;
                border-bottom: 1px solid rgba(255, 255, 255, 0.3);
                padding-bottom: 5px;
            }
            
            .controls-panel table {
                width: 100%;
                border-collapse: collapse;
            }
            
            .controls-panel td {
                padding: 3px 5px;
            }
            
            .controls-panel .key {
                display: inline-block;
                background-color: rgba(255, 255, 255, 0.2);
                border-radius: 4px;
                padding: 2px 6px;
                margin: 2px;
                font-weight: bold;
                text-align: center;
                min-width: 20px;
            }
        `,document.head.appendChild(t)}showNotification(t,e=3e3){this.notificationTimeout&&clearTimeout(this.notificationTimeout),this.notification.textContent=t,this.notification.classList.add("visible"),this.notificationTimeout=setTimeout(()=>{this.notification.classList.remove("visible")},e)}setupEventListeners(){this.playButton.addEventListener("click",()=>{this.game.gameState.changeState("GAMEPLAY"),this.hideStartScreen(),this.showGameplayUI(),this.game.cameraController.animateToGameplayPosition()}),this.tryAgainButton.addEventListener("click",()=>{this.game.gameState.changeState("START_SCREEN"),this.hideEndScreen(),this.hideGameplayUI(),this.showStartScreen(),this.game.character.resetPosition(),this.game.cameraController.animateToStartPosition()})}onGameStateChange(t,e){switch(t){case"START_SCREEN":this.showStartScreen(),this.hideGameplayUI(),this.hideEndScreen();break;case"GAMEPLAY":this.hideStartScreen(),this.showGameplayUI(),this.hideEndScreen(),this.progressBar&&(this.progressBar.style.width="0%");break;case"END_SCREEN":this.hideStartScreen(),this.hideGameplayUI(),this.showEndScreen();break}}showStartScreen(){this.startScreen.style.display="flex";const t=this.startScreen.querySelector("h1");t&&(t.style.opacity=0,t.style.transform="translateY(-20px)",setTimeout(()=>{t.style.transition="opacity 1s ease, transform 1s ease",t.style.opacity=1,t.style.transform="translateY(0)"},100))}hideStartScreen(){this.startScreen.style.display="none"}showGameplayUI(){this.gameplayUI.style.display="block",this.gameplayUI.querySelectorAll("div[id]").forEach((e,i)=>{e.style.opacity=0,setTimeout(()=>{e.style.transition="opacity 0.5s ease",e.style.opacity=1},100*i)}),this.showControlsPanel()}showControlsPanel(){let t=document.getElementById("controls-panel");t||(t=document.createElement("div"),t.id="controls-panel",t.className="controls-panel",t.innerHTML=`
                <h3>Controls</h3>
                <table>
                    <tr>
                        <td><span class="key">W</span> / <span class="key">↑</span></td>
                        <td>Move forward</td>
                    </tr>
                    <tr>
                        <td><span class="key">A</span> / <span class="key">←</span></td>
                        <td>Lean left</td>
                    </tr>
                    <tr>
                        <td><span class="key">D</span> / <span class="key">→</span></td>
                        <td>Lean right</td>
                    </tr>
                    <tr>
                        <td><span class="key">C</span></td>
                        <td>Toggle camera mode</td>
                    </tr>
                    <tr>
                        <td><span class="key">Left-click</span></td>
                        <td>Orbit camera</td>
                    </tr>
                    <tr>
                        <td><span class="key">Right-click</span></td>
                        <td>Pan camera</td>
                    </tr>
                    <tr>
                        <td><span class="key">Scroll</span></td>
                        <td>Zoom camera</td>
                    </tr>
                </table>
            `,document.body.appendChild(t)),setTimeout(()=>{t.classList.add("visible")},500)}hideControlsPanel(){const t=document.getElementById("controls-panel");t&&t.classList.remove("visible")}hideGameplayUI(){this.gameplayUI.style.display="none",this.hideControlsPanel()}showEndScreen(t="Journey Complete"){this.endScreen.style.display="flex",this.endMessage.textContent=t;const e=Math.floor(this.game.clock.elapsedTime),i=Math.floor(this.game.character.position*100),s=Math.floor(e/60),o=e%60,a=s>0?`${s} min ${o} sec`:`${o} seconds`;t.includes("fell")?(this.performanceMetrics.innerHTML=`
                <span style="color: #e74c3c;">❌ You lost your balance!</span><br>
                Distance: ${i}%<br>
                Time: ${a}
            `,this.endMessage.style.color="#e74c3c"):(this.performanceMetrics.innerHTML=`
                <span style="color: #2ecc71;">✓ Successfully crossed the rope!</span><br>
                Time: ${a}
            `,this.endMessage.style.color="#2ecc71"),[this.endMessage,this.performanceMetrics,this.tryAgainButton].forEach((c,r)=>{c&&(c.style.opacity=0,c.style.transform="translateY(20px)",setTimeout(()=>{c.style.transition="opacity 0.8s ease, transform 0.8s ease",c.style.opacity=1,c.style.transform="translateY(0)"},300*r))})}hideEndScreen(){this.endScreen.style.display="none"}updateGameplayUI(t){const e=50+t*50;this.balanceMarker.style.left=`${e}%`;const i=Math.abs(t);i>.7?(this.balanceMarker.style.backgroundColor="#e74c3c",this.balanceMarker.style.boxShadow="0 0 8px rgba(231, 76, 60, 0.8)"):i>.4?(this.balanceMarker.style.backgroundColor="#f39c12",this.balanceMarker.style.boxShadow="0 0 8px rgba(243, 156, 18, 0.8)"):(this.balanceMarker.style.backgroundColor="white",this.balanceMarker.style.boxShadow="0 0 8px rgba(255, 255, 255, 0.7)"),this.updateWindDirection(),this.updateProgressBar()}updateProgressBar(){if(this.progressBar&&this.game.character){const t=this.game.character.position*100;this.progressBar.style.width=`${t}%`,t>80?this.progressBar.style.background="linear-gradient(90deg, #2ecc71, #27ae60)":t>50?this.progressBar.style.background="linear-gradient(90deg, #f1c40f, #f39c12)":this.progressBar.style.background="linear-gradient(90deg, #3498db, #2980b9)"}}updateWindDirection(){const t=this.game.physics;if(!t||!this.windDirectionElement)return;if(t.windForce===0){this.windDirectionElement.textContent="None",this.windDirectionElement.style.color="white";return}let e="",i="";t.windDirection>.2?(e="Right",i="#3498db"):t.windDirection<-.2?(e="Left",i="#3498db"):(e="Mild",i="white");const s=Math.abs(t.windForce);let o="";s>.35?(o=t.windDirection>0?"→→→":"←←←",i="#e74c3c"):s>.15?(o=t.windDirection>0?"→→":"←←",i="#f39c12"):o=t.windDirection>0?"→":"←",this.windDirectionElement.innerHTML=`${e} <span style="font-size: 22px;">${o}</span>`,this.windDirectionElement.style.color=i,s>.3?this.windDirectionElement.style.animation="shake 0.5s infinite":this.windDirectionElement.style.animation="none"}shakeElement(t,e=3){const i=document.getElementById(t);i&&(i.classList.contains("shaking")||(i.classList.add("shaking"),i.style.setProperty("--shake-intensity",`${e*2}px`),setTimeout(()=>{i.classList.remove("shaking")},500)))}}class te{constructor(){this.currentState=null,this.previousState=null,this.stateChangeListeners=[],this.validTransitions={START_SCREEN:["GAMEPLAY"],GAMEPLAY:["PAUSED","END_SCREEN"],PAUSED:["GAMEPLAY","START_SCREEN"],END_SCREEN:["START_SCREEN"]}}changeState(t){return this.currentState&&(!this.validTransitions[this.currentState]||!this.validTransitions[this.currentState].includes(t))?(console.warn(`Invalid state transition: ${this.currentState} -> ${t}`),!1):(console.log(`State transition: ${this.currentState||"NONE"} -> ${t}`),this.previousState=this.currentState,this.currentState=t,this.notifyStateChangeListeners(),!0)}addStateChangeListener(t){typeof t=="function"&&!this.stateChangeListeners.includes(t)&&this.stateChangeListeners.push(t)}removeStateChangeListener(t){const e=this.stateChangeListeners.indexOf(t);e!==-1&&this.stateChangeListeners.splice(e,1)}notifyStateChangeListeners(){for(const t of this.stateChangeListeners)t(this.currentState,this.previousState)}}class ee{constructor(t=Math){this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(let e=0;e<256;e++)this.p[e]=Math.floor(t.random()*256);this.perm=[];for(let e=0;e<512;e++)this.perm[e]=this.p[e&255];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(t,e,i){return t[0]*e+t[1]*i}dot3(t,e,i,s){return t[0]*e+t[1]*i+t[2]*s}dot4(t,e,i,s,o){return t[0]*e+t[1]*i+t[2]*s+t[3]*o}noise(t,e){let i,s,o;const a=.5*(Math.sqrt(3)-1),n=(t+e)*a,c=Math.floor(t+n),r=Math.floor(e+n),m=(3-Math.sqrt(3))/6,u=(c+r)*m,p=c-u,g=r-u,d=t-p,h=e-g;let f,w;d>h?(f=1,w=0):(f=0,w=1);const y=d-f+m,M=h-w+m,P=d-1+2*m,b=h-1+2*m,L=c&255,C=r&255,R=this.perm[L+this.perm[C]]%12,v=this.perm[L+f+this.perm[C+w]]%12,A=this.perm[L+1+this.perm[C+1]]%12;let k=.5-d*d-h*h;k<0?i=0:(k*=k,i=k*k*this.dot(this.grad3[R],d,h));let x=.5-y*y-M*M;x<0?s=0:(x*=x,s=x*x*this.dot(this.grad3[v],y,M));let T=.5-P*P-b*b;return T<0?o=0:(T*=T,o=T*T*this.dot(this.grad3[A],P,b)),70*(i+s+o)}noise3d(t,e,i){let s,o,a,n;const r=(t+e+i)*.3333333333333333,m=Math.floor(t+r),u=Math.floor(e+r),p=Math.floor(i+r),g=1/6,d=(m+u+p)*g,h=m-d,f=u-d,w=p-d,y=t-h,M=e-f,P=i-w;let b,L,C,R,v,A;y>=M?M>=P?(b=1,L=0,C=0,R=1,v=1,A=0):y>=P?(b=1,L=0,C=0,R=1,v=0,A=1):(b=0,L=0,C=1,R=1,v=0,A=1):M<P?(b=0,L=0,C=1,R=0,v=1,A=1):y<P?(b=0,L=1,C=0,R=0,v=1,A=1):(b=0,L=1,C=0,R=1,v=1,A=0);const k=y-b+g,x=M-L+g,T=P-C+g,V=y-R+2*g,K=M-v+2*g,U=P-A+2*g,_=y-1+3*g,X=M-1+3*g,E=P-1+3*g,G=m&255,B=u&255,W=p&255,ot=this.perm[G+this.perm[B+this.perm[W]]]%12,nt=this.perm[G+b+this.perm[B+L+this.perm[W+C]]]%12,at=this.perm[G+R+this.perm[B+v+this.perm[W+A]]]%12,rt=this.perm[G+1+this.perm[B+1+this.perm[W+1]]]%12;let I=.6-y*y-M*M-P*P;I<0?s=0:(I*=I,s=I*I*this.dot3(this.grad3[ot],y,M,P));let z=.6-k*k-x*x-T*T;z<0?o=0:(z*=z,o=z*z*this.dot3(this.grad3[nt],k,x,T));let F=.6-V*V-K*K-U*U;F<0?a=0:(F*=F,a=F*F*this.dot3(this.grad3[at],V,K,U));let O=.6-_*_-X*X-E*E;return O<0?n=0:(O*=O,n=O*O*this.dot3(this.grad3[rt],_,X,E)),32*(s+o+a+n)}noise4d(t,e,i,s){const o=this.grad4,a=this.simplex,n=this.perm,c=(Math.sqrt(5)-1)/4,r=(5-Math.sqrt(5))/20;let m,u,p,g,d;const h=(t+e+i+s)*c,f=Math.floor(t+h),w=Math.floor(e+h),y=Math.floor(i+h),M=Math.floor(s+h),P=(f+w+y+M)*r,b=f-P,L=w-P,C=y-P,R=M-P,v=t-b,A=e-L,k=i-C,x=s-R,T=v>A?32:0,V=v>k?16:0,K=A>k?8:0,U=v>x?4:0,_=A>x?2:0,X=k>x?1:0,E=T+V+K+U+_+X,G=a[E][0]>=3?1:0,B=a[E][1]>=3?1:0,W=a[E][2]>=3?1:0,ot=a[E][3]>=3?1:0,nt=a[E][0]>=2?1:0,at=a[E][1]>=2?1:0,rt=a[E][2]>=2?1:0,I=a[E][3]>=2?1:0,z=a[E][0]>=1?1:0,F=a[E][1]>=1?1:0,O=a[E][2]>=1?1:0,Lt=a[E][3]>=1?1:0,ct=v-G+r,mt=A-B+r,dt=k-W+r,ft=x-ot+r,pt=v-nt+2*r,gt=A-at+2*r,ut=k-rt+2*r,wt=x-I+2*r,yt=v-z+3*r,Mt=A-F+3*r,Pt=k-O+3*r,bt=x-Lt+3*r,vt=v-1+4*r,At=A-1+4*r,St=k-1+4*r,kt=x-1+4*r,q=f&255,$=w&255,Z=y&255,Q=M&255,Tt=n[q+n[$+n[Z+n[Q]]]]%32,Nt=n[q+G+n[$+B+n[Z+W+n[Q+ot]]]]%32,It=n[q+nt+n[$+at+n[Z+rt+n[Q+I]]]]%32,zt=n[q+z+n[$+F+n[Z+O+n[Q+Lt]]]]%32,Ft=n[q+1+n[$+1+n[Z+1+n[Q+1]]]]%32;let J=.6-v*v-A*A-k*k-x*x;J<0?m=0:(J*=J,m=J*J*this.dot4(o[Tt],v,A,k,x));let tt=.6-ct*ct-mt*mt-dt*dt-ft*ft;tt<0?u=0:(tt*=tt,u=tt*tt*this.dot4(o[Nt],ct,mt,dt,ft));let et=.6-pt*pt-gt*gt-ut*ut-wt*wt;et<0?p=0:(et*=et,p=et*et*this.dot4(o[It],pt,gt,ut,wt));let it=.6-yt*yt-Mt*Mt-Pt*Pt-bt*bt;it<0?g=0:(it*=it,g=it*it*this.dot4(o[zt],yt,Mt,Pt,bt));let st=.6-vt*vt-At*At-St*St-kt*kt;return st<0?d=0:(st*=st,d=st*st*this.dot4(o[Ft],vt,At,St,kt)),27*(m+u+p+g+d)}}class ie{constructor(t){this.scene=t,this.rope=null,this.mountains=[],this.clouds=[],this.lights=[],this.ropeSegments=10,this.ropeThickness=.3,this.mountainDistance=100,this.mountainHeight=100,this.mountainRadius=100,this.platforms=[],this.platformRadius=8,this.platformHeight=2,this.startPlatformPosition=null,this.endPlatformPosition=null,this.noise=null}async load(){return this.noise=new ee,this.createSkybox(),this.createLighting(),this.createTerrain(),await this.createMountains(),this.createPlatforms(),this.createRope(),Promise.resolve()}createSkybox(){const t=`
            varying vec3 vWorldPosition;
            void main() {
                vec4 worldPosition = modelMatrix * vec4(position, 1.0);
                vWorldPosition = worldPosition.xyz;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
        `,e=`
            uniform vec3 topColor;
            uniform vec3 bottomColor;
            uniform float offset;
            uniform float exponent;
            varying vec3 vWorldPosition;
            void main() {
                float h = normalize(vWorldPosition + offset).y;
                gl_FragColor = vec4(mix(bottomColor, topColor, max(pow(max(h, 0.0), exponent), 0.0)), 1.0);
            }
        `,i={topColor:{value:new xt(30719)},bottomColor:{value:new xt(11534335)},offset:{value:33},exponent:{value:.6}},s=new Bt({vertexShader:t,fragmentShader:e,uniforms:i,side:Wt}),o=new H(500,32,32),a=new S(o,s);this.scene.add(a)}createLighting(){const t=new Ht(16777215,.5);this.scene.add(t),this.lights.push(t);const e=new Yt(16777215,.8);e.position.set(100,100,50),e.castShadow=!0,e.shadow.mapSize.width=4096,e.shadow.mapSize.height=4096,e.shadow.camera.near=10,e.shadow.camera.far=500,e.shadow.camera.left=-150,e.shadow.camera.right=150,e.shadow.camera.top=150,e.shadow.camera.bottom=-150,this.scene.add(e),this.lights.push(e);const i=new jt(35071,65416,.6);this.scene.add(i),this.lights.push(i)}createTerrain(){const i=new Vt(1e3,1e3,100,100);i.rotateX(-Math.PI/2);const s=i.attributes.position.array;for(let m=0;m<s.length;m+=3){const u=s[m],p=s[m+2],g=Math.sqrt(u*u+p*p);if(g>this.mountainRadius+10){const d=this.noise.noise(u*.01,p*.01)*15,h=Math.min(1,(g-this.mountainRadius-10)/50);s[m+1]=d*h-10}else s[m+1]=-10}i.computeVertexNormals();const o=new ht,a=50,n=o.load("https://threejs.org/examples/textures/terrain/grasslight-big.jpg");n.wrapS=n.wrapT=lt,n.repeat.set(a,a);const c=new D({map:n,roughness:.8,metalness:.1,color:5271632}),r=new S(i,c);r.receiveShadow=!0,this.scene.add(r)}async createMountains(){await this.createRealisticMountain(new l(0,0,this.mountainDistance),this.mountainHeight,this.mountainRadius,!0),await this.createRealisticMountain(new l(0,0,-this.mountainDistance),this.mountainHeight,this.mountainRadius,!1)}async createRealisticMountain(t,e,i,s){const o=new Rt(i,e,48,32,!1),a=o.attributes.position.array;let n=1/0,c=-1/0;for(let h=0;h<a.length;h+=3){const f=a[h+1];n=Math.min(n,f),c=Math.max(c,f)}for(let h=0;h<a.length;h+=3){const f=a[h],w=a[h+1],y=a[h+2],M=(w-n)/(c-n),P=Math.sqrt(f*f+y*y);let b=1;M>.95&&(b=1-(M-.95)/.05*.9);const L=.1+M*.3*b,C=2+M*3*b,R=this.noise.noise(f*.5,w*.5,y*.5)*.5*b,v=this.noise.noise(f*L,w*L,y*L)*C*b,A=Math.max(0,1-Math.pow(M,3)*8),k=f/P,x=y/P;!isNaN(k)&&!isNaN(x)&&(a[h]+=k*(v+R)*A,a[h+1]+=(v+R)*.3*A,a[h+2]+=x*(v+R)*A)}o.computeVertexNormals(),new ht;const r=new D({color:7829367,roughness:.9,metalness:.1,flatShading:!0}),m=new D({color:16777215,roughness:.8,metalness:.1}),u=new S(o,r);u.position.copy(t),u.castShadow=!0,u.receiveShadow=!0,this.scene.add(u),this.mountains.push(u);const p=o.clone(),g=p.attributes.position.array;for(let h=0;h<g.length;h+=3){const w=(g[h+1]-n)/(c-n),y=g[h],M=g[h+2],b=.65+this.noise.noise(y*.1,M*.1)*.1;w<b&&(g[h]*=.98,g[h+1]=n-10,g[h+2]*=.98)}p.computeVertexNormals();const d=new S(p,m);d.position.copy(t),d.castShadow=!0,this.scene.add(d),this.addRockFormations(t,i),this.createMountainTop(t,e,s)}createMountainTop(t,e,i){console.log(t,e,i);const s=new l(t.x,t.y+e/2,t.z);i?this.startPlatformPosition=s:this.endPlatformPosition=s}addRockFormations(t,e){const i=new D({color:5592405,roughness:1,metalness:0,flatShading:!0}),s=8+Math.floor(Math.random()*5),o=e*.5,a=e*.9;for(let n=0;n<s;n++){const c=Math.random()*Math.PI*2,r=o+Math.random()*(a-o),m=Math.cos(c)*r,u=Math.sin(c)*r,p=3+Math.random()*7,g=2+Math.random()*5;let d;Math.random()>.5?d=new H(p,8,6):d=new Rt(p,g,8);const h=d.attributes.position.array;for(let w=0;w<h.length;w+=3){const y=h[w],M=h[w+1],P=h[w+2],b=this.noise.noise(y*.3,M*.3,P*.3)*1.5;h[w]+=y*.2*b,h[w+1]+=M*.2*b,h[w+2]+=P*.2*b}d.computeVertexNormals();const f=new S(d,i);f.position.set(t.x+m,t.y-5+Math.random()*2,t.z+u),f.rotation.set(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2),f.castShadow=!0,f.receiveShadow=!0,this.scene.add(f)}}createPlatforms(){if(!this.startPlatformPosition||!this.endPlatformPosition)return;const e=new ht().load("https://threejs.org/examples/textures/hardwood2_diffuse.jpg");e.wrapS=e.wrapT=lt,e.repeat.set(2,2);const i=new D({map:e,roughness:.8,metalness:.1}),s=new j(this.platformRadius,this.platformRadius*1.05,this.platformHeight,16),o=new S(s,i);o.position.copy(this.startPlatformPosition),o.receiveShadow=!0,console.log("startPlatform",o),this.scene.add(o),this.platforms.push(o);const a=new j(this.platformRadius,this.platformRadius*1.05,this.platformHeight,16),n=new S(a,i);n.position.copy(this.endPlatformPosition),n.receiveShadow=!0,this.scene.add(n),this.platforms.push(n),this.addPlatformRailings(o,!0),this.addPlatformRailings(n,!1)}addPlatformRailings(t,e){const a=new D({color:9127187,roughness:.9,metalness:.1});for(let n=0;n<8;n++){if(e&&(n===0||n===7)||!e&&(n===8/2||n===8/2-1))continue;const c=n/8*Math.PI*2,r=Math.cos(c)*(this.platformRadius-.1/2),m=Math.sin(c)*(this.platformRadius-.1/2),u=new j(.1,.1,1.2,8),p=new S(u,a);p.position.set(t.position.x+r,t.position.y+this.platformHeight/2+1.2/2,t.position.z+m),p.castShadow=!0,this.scene.add(p)}}createRope(){if(!this.startPlatformPosition||!this.endPlatformPosition)return;const t=[],e=new l(this.startPlatformPosition.x,this.startPlatformPosition.y+this.platformHeight/2+this.ropeThickness/2,this.startPlatformPosition.z-this.platformRadius),i=new l(this.endPlatformPosition.x,this.endPlatformPosition.y+this.platformHeight/2+this.ropeThickness/2,this.endPlatformPosition.z+this.platformRadius),s=this.ropeSegments,o=this.mountainDistance/40;for(let u=0;u<=s;u++){const p=u/s,g=e.x+(i.x-e.x)*p,d=e.z+(i.z-e.z)*p,h=e.y+(i.y-e.y)*p,f=Math.sin(Math.PI*p)*o,w=h-f;t.push(new l(g,w,d))}const a=new Kt(t),n=new Ut(a,s,this.ropeThickness,8,!1),r=new ht().load("https://threejs.org/examples/textures/rope.jpg");r.wrapS=lt,r.wrapT=lt,r.repeat.set(15,1);const m=new D({map:r,color:9127187,roughness:.9,metalness:0});this.rope=new S(n,m),this.rope.castShadow=!0,this.scene.add(this.rope)}createClouds(){const t=new D({color:16777215,roughness:.5,metalness:.1,transparent:!0,opacity:.9});for(let e=0;e<30;e++){const i=new Y,s=4+Math.floor(Math.random()*5);for(let a=0;a<s;a++){const n=8+Math.random()*8,c=new H(n,8,8),r=new S(c,t);r.position.set(a*10-s*5+Math.random()*10,Math.random()*5,Math.random()*10),r.scale.y=.6+Math.random()*.2,i.add(r)}i.position.set(Math.random()*600-300,80+Math.random()*50,Math.random()*600-300);const o=.8+Math.random()*1.5;i.scale.set(o,o,o),this.scene.add(i),this.clouds.push(i),i.userData={speedX:(Math.random()*2-1)*3,speedZ:(Math.random()*2-1)*3,rotationSpeed:(Math.random()*2-1)*.01}}}update(t){for(const e of this.clouds)e.position.x+=e.userData.speedX*t,e.position.z+=e.userData.speedZ*t,e.rotation.y+=e.userData.rotationSpeed*t,e.position.x>300&&(e.position.x=-300),e.position.x<-300&&(e.position.x=300),e.position.z>300&&(e.position.z=-300),e.position.z<-300&&(e.position.z=300)}}class se{constructor(){this.scene=null,this.renderer=null,this.clock=null,this.gameState=null,this.uiManager=null,this.cameraController=null,this.character=null,this.physics=null,this.environment=null,this.gameContainer=document.getElementById("game-container"),this.update=this.update.bind(this),this.onWindowResize=this.onWindowResize.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this)}async init(){console.log("Initializing game..."),this.scene=new _t,this.scene.background=new xt(8900331),this.renderer=new Xt({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.gameContainer.appendChild(this.renderer.domElement);const t=new qt(75,window.innerWidth/window.innerHeight,.1,1e3);this.cameraController=new $t(this.scene,t),this.clock=new Dt,this.gameState=new te,this.uiManager=new Jt(this),this.physics=new Qt,this.environment=new ie(this.scene),await this.environment.load(),this.character=new Zt(this.scene,this.environment.rope,this.environment),await this.character.load(),this.cameraController.setReferences(this.character,this.environment),window.addEventListener("resize",this.onWindowResize),window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),this.gameState.changeState("START_SCREEN"),console.log("Game initialization complete")}start(){console.log("Starting game loop"),this.update()}update(){requestAnimationFrame(this.update);const t=this.clock.getDelta();switch(this.gameState.currentState){case"START_SCREEN":this.cameraController.update(t);break;case"GAMEPLAY":this.physics.applyForces(this.character,t),this.character.update(t),this.environment.update(t),this.cameraController.update(t),this.uiManager.updateGameplayUI(this.character.balance),this.physics.checkBalance(this.character)||(this.gameState.changeState("END_SCREEN"),this.uiManager.showEndScreen("You fell!")),this.character.position>=.98&&this.character.isOnPlatform&&(this.gameState.changeState("END_SCREEN"),this.uiManager.showEndScreen("You made it across!"));break}this.renderer.render(this.scene,this.cameraController.camera)}onWindowResize(){const t=window.innerWidth,e=window.innerHeight;this.cameraController.camera.aspect=t/e,this.cameraController.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)}handleKeyDown(t){if(this.gameState.currentState==="GAMEPLAY")switch(t.key){case"ArrowLeft":case"a":case"A":this.character.isOnPlatform?this.character.moveLeft():this.character.adjustBalance(-1);break;case"ArrowRight":case"d":case"D":this.character.isOnPlatform?this.character.moveRight():this.character.adjustBalance(1);break;case"ArrowUp":case"w":case"W":this.character.moveForward();break;case"ArrowDown":case"s":case"S":this.character.isOnPlatform&&this.character.moveBackward();break;case"q":case"Q":this.character.isOnPlatform&&this.character.rotateLeft();break;case"e":case"E":this.character.isOnPlatform&&this.character.rotateRight();break;case"c":case"C":this.toggleCameraMode();break}}handleKeyUp(t){if(this.gameState.currentState==="GAMEPLAY")switch(t.key){case"ArrowLeft":case"a":case"A":this.character.isOnPlatform?this.character.stopMovingLeft():this.character.adjustBalance(0);break;case"ArrowRight":case"d":case"D":this.character.isOnPlatform?this.character.stopMovingRight():this.character.adjustBalance(0);break;case"ArrowUp":case"w":case"W":this.character.stopMoving();break;case"ArrowDown":case"s":case"S":this.character.isOnPlatform&&this.character.stopMovingBackward();break;case"q":case"Q":this.character.isOnPlatform&&this.character.stopRotatingLeft();break;case"e":case"E":this.character.isOnPlatform&&this.character.stopRotatingRight();break}}toggleCameraMode(){if(this.cameraController.enableMouseControls){this.cameraController.setMouseControlsEnabled(!1);const e=this.character.model.position.clone(),i=new l(e.x,e.y+3,e.z+8),s=new l(e.x,e.y+1,e.z-10);this.cameraController.animateToPosition(i,s,1),this.uiManager.showNotification("Camera Mode: Automatic Following",2e3),this.cameraController.setFollowTarget(this.character.model)}else this.cameraController.setMouseControlsEnabled(!0),this.cameraController.clearFollowTarget(),this.uiManager.showNotification("Camera Mode: Manual Control",2e3),setTimeout(()=>{this.uiManager.showNotification("Left-click: Orbit | Right-click: Pan | Scroll: Zoom",4e3)},2500)}}const Et=new se;Et.init().then(()=>{Et.start()});
//# sourceMappingURL=index-BdnMWqE9.js.map
